/*
Copyright (c) 2012, comScore Inc. All rights reserved.
version: 5.0.3
*/
var _halt=false;
var _reg = /^http(s)?\:\/\/www\.windowsphone\.com/i.test(document.referrer);
if(_reg){
	_halt = true;
}

COMSCORE.SiteRecruit.Broker.config = {
	version: "5.0.3",
	cddsDomains: '.microsoft.com|www.microsoftstore.com|www.xbox.com',
	cddsInProgress: 'cddsinprogress',
	domainSwitch: 'tracking3p',
	domainMatch: '([\\da-z\.-]+\.com)',
	delay: 3000,
	
	//TODO:Karl extend cookie enhancements to ie userdata
		testMode: false,
	
	// cookie settings
	cookie:{
		name: 'msresearch',
		path: '/',
		domain:  '.windowsphone.com' ,
		duration: 90,
		rapidDuration: 0,
		expireDate: ''
	},
	thirdPartyOptOutCookieEnabled : true,
	thirdPartyOptOutCookie1:{
		name: 'ar_p127227702',
		path: '',
		domain: '',
		duration: 0,
		rapidDuration: 0,
		expireDate: ''
	},
	thirdPartyOptOutCookie2:{
		name: '' ,
		path: '',
		domain: '',
		duration: 0,
		rapidDuration: 0,
		expireDate: ''
	},	
	
	
	// optional prefix for pagemapping's pageconfig file
	prefixUrl: "",
	
	//events
	Events: {
		beforeRecruit: function() {
					}
	},
	
		mapping:[
	// m=regex match, c=page config file (prefixed with configUrl), f=frequency
	{m: '//[\\w\\.-]+/en-us', c: 'inv_c_p127227702-US.js', f: 0, p: 0, halt: true }
 ,{m: '//[\\w\\.-]+/en-gb', c: 'inv_c_p127227702-GB.js', f: 0, p: 0, halt: true } 
 ,{m: '//[\\w\\.-]+/fr-fr', c: 'inv_c_p127227702-FR.js', f: 0, p: 0, halt: true }
 ,{m: '//[\\w\\.-]+/de-de', c: 'inv_c_p127227702-DE.js', f: 0, p: 0, halt: true }
 ,{m: '//[\\w\\.-]+/es-es', c: 'inv_c_p127227702-ES.js', f: 0, p: 0, halt: true }
 ,{m: '//[\\w\\.-]+/es-mx', c: 'inv_c_p127227702-MX.js', f: 0, p: 0, halt: true }
 ,{m: '//[\\w\\.-]+/es-cl', c: 'inv_c_p127227702-CL.js', f: 0, p: 0, halt: true }
 ,{m: '//[\\w\\.-]+/pt-br', c: 'inv_c_p127227702-PT.js', f: 0, p: 0, halt: true }
 ,{m: '//[\\w\\.-]+/en-us/features-8-1', c: 'inv_c_p127227702-US-2533.js', f: 0, p: 0, halt: true } 
]
};


function _set_SessionCookie(n, f){
	if (n == COMSCORE.SiteRecruit.Broker.config.domainSwitch) {
		f = f.split('.');
		var dom = "";
		
		for (i=0; i<f.length; i++) {
			var r = new RegExp('\/');
			if (i>0 && r.test(f[i])) {
				f[i] = f[i].substring(0,f[i].indexOf("/"));
				dom += f[i];
				i = f.length;
			}
			else {
				dom += f[i] + ".";
			}
		}
		
		f = dom;
	}
	
  var c = n+'=' + f  	    	
  				+ '; path=/'
   			 	+ '; domain=.windowsphone.com';
	document.cookie = c;	
}
var allLinks = document.getElementsByTagName("a");
 for (var i = 0, n = allLinks.length; i < n; i++) {
	if(/(https:\/\/www\.windowsphone\.com\/(en-(us|gb)|de-de|fr-fr|)\/(my|family))|signin/i.test(allLinks[i].href)){
		if(allLinks[i].addEventListener){
			allLinks[i].addEventListener('click',function(event){
				_set_SessionCookie("graceIncr", 1);
				},false);
		}else{
			hrefURL = allLinks[i].href;
			allLinks[i].attachEvent('onclick',function(){ 
				_set_SessionCookie("graceIncr", 1);
				});
		}
 	}
 	
 	var r = new RegExp(COMSCORE.SiteRecruit.Broker.config.cddsDomains,'i');
	
	if (r.test(allLinks[i].href)) {
		if (allLinks[i].addEventListener) {
			allLinks[i].addEventListener('click', function(event) {
				if (r.test(this.href)) {
					_set_SessionCookie(COMSCORE.SiteRecruit.Broker.config.domainSwitch, this.href);
				}
			}, false);
		}
		else {
			hrefURL = allLinks[i].href;
			allLinks[i].attachEvent('onclick', function() {
				_set_SessionCookie(COMSCORE.SiteRecruit.Broker.config.domainSwitch, hrefURL);
			});
		}
	}
 }

	var gIdelay = 0;
	if (COMSCORE.SiteRecruit.Utils.UserPersistence.getCookieValue("graceIncr") == 1) {
		gIdelay = 5000;
	}
	setTimeout(function(){_set_SessionCookie("graceIncr", 0)},gIdelay);
	//_set_SessionCookie("graceIncr", 0);

//CUSTOM - CHECK FOR THE CROSS-DOMAIN COOKIE. IF PRESENT, HALT RECRUITMENT AND SET DD TRACKING COOKIE
	function crossDomainCheck() {
		if (intervalMax > 0) {
			intervalMax --;
			
			var cookieName = COMSCORE.SiteRecruit.Broker.config.cddsInProgress;
			
			if (COMSCORE.SiteRecruit.Utils.UserPersistence.getCookieValue(cookieName) != false ) {
				COMSCORE.SiteRecruit.DDKeepAlive.setDDTrackerCookie();
				COMSCORE.SiteRecruit._halt = true;
				clearCrossDomainCheck();
			}
		}
		else {
			clearCrossDomainCheck();
		}
	}

	function clearCrossDomainCheck() {
		window.clearInterval(crossDomainInterval);
	}

	var intervalMax = 10;
	
	var crossDomainInterval = window.setInterval('crossDomainCheck()', '1000');
//END CROSS_DOMAIN DEPARTURE FUNCTIONALITY



//CUSTOM - ADD 5 SECOND DELAY ON CALLING BROKER.RUN()
if (COMSCORE.SiteRecruit.Broker.delayConfig == true)  {
	COMSCORE.SiteRecruit.Broker.config.delay = 1000;
}
window.setTimeout('COMSCORE.SiteRecruit.Broker.run()', COMSCORE.SiteRecruit.Broker.config.delay);
//END CUSTOM